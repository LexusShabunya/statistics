---
title: "ЛР3_Вар26_ШабуняАлексей_МС4"
author: "Шабуня Алексей Андреевич"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### 3.1. Однофакторный дисперсионный анализ (One-Way ANOVA)

##### 3.1.1. Основные понятия

Рассмотрим дисперсионный анализ на примере задачи 7.61 из ДКР3, где доля школьников получивших золотую медаль зависит от района города, в котором располагается школа, и типа школы.

Для этого загрузим таблицу с данными, а также установим необходимую библиотеку `readxl`:

```{r}
library(readxl) 
data = read_excel('7_61.xlsx')
```

В данной таблице имеется 12 наблюдений. Первая переменная `School_type` -- тип школы. Вторая переменная `District` -- район, в котором располагается школа. Выведем таблицу с данными:

```{r}
data
```

Начнем с расчета средних значений по каждому показателю. Для этого используем функцию `tapply`. Тем самым мы получим значение средней доли школьников получивших золотую медаль. Посмотрим, что получилось:

```{r}
meanSchool_type = tapply(data$Medals, data$School_type, mean)
meanSchool_type

meanDistrict = tapply(data$Medals, data$District, mean)
meanDistrict
```

##### 3.1.2. Графическое представление различий между средними изучаемых групп

Построим два графика, которые также сгруппируют нам значения доли школьников получивших золотую медаль по соответствующим уровням факторов, отдельно для типа школы и отдельно для района в котором находится школа. Посмотрим, что даст соответствующая операция `stripchart()`:

```{r, fig.cap='Рис. 9. Точечный график зависимости доли школьников получивших золотую медаль от типа школы (построен с помощью встроенной функции stripchart)'}
stripchart(Medals ~ School_type, data=data, col='red', ylab='School_type', xlab='Medals', main='School_type')
```

Здесь можно заметить некоторую тенденцию, что в среднем ученики школ с углублённым изучением физики и математики получают большую долю золотых медалей, а меньшую долю золотых медалей получают ученики общеобразовательных школ. Тем не менее визуально однозначного вывода сделать нельзя, нужно будет применить более строгие критерии. Аналогично построим для времени суток:

```{r, fig.cap='Рис.10. Точечный график зависимости доли школьников получивших золотую медаль от района, в котором находится школа (построен с помощью встроенной функции stripchart'}
stripchart(Medals ~ District, data=data, col='blue', ylab='District', xlab='Medals', main='District')
```

На рис. 10 наблюдаются явные отличия долей золотых медалей среди школьников, но это требует более строгой проверки.

Кроме того, можно изобразить значения средних по типу школы. По этому графику мы можем наблюдать, что наибольшие доли золотых медалей имеют ученики школ с углублённым изучением физики и математики:

```{r, fig.cap='Рис. 11. Точечный график зависимости средней доли школьников получивших золотую медаль в зависимости от  типа школы (построен с помощью встроенной функции plot)'}
plot(meanSchool_type, type='o', col='red', xlab='School_type', ylab='Medals')
```

Построим также аналогичный график для района, в котором располагается школа (рис.12):

```{r, fig.cap='Рис. 12. Точечный график зависимости средней доли школьников получивших золотую медаль в зависимости от региона, в котором расположена школа  (построен с помощью встроенной функции plot)'}
plot(meanDistrict, type='o', col='blue', xlab='District', ylab='Medals')
```

Здесь мы наблюдаем, что в среднем наименьшую долю золотых медалей имеют школьники из первого района, второй и третий район в среднем имеют одинаковую долю школьников получивших золотую медаль, ну и наибольшую среднюю долю школьников с золотыми медалями имеет четвёртый район, но нам необходимо проверить, является ли данное отличие статистически значимым. На этот вопрос нам поможет ответить дисперсионный анализ, который проведем чуть позже.

Также на этапе предварительного анализа можно построить более информативные графики - например, box plot. Ящичковые диаграммы мы можем построить, сгруппировав наблюдения по типу школы или району.

Построим график типа box plot для типов школ (рис. 14):

```{r, fig.cap='Рис. 14. Ящичковая диаграмма (box plot) доли школьников получивших золотую медаль в зависимости от типа школы (построена с помощью встроенной функции boxplot)'}
boxplot(Medals ~ School_type, data=data, ylab='Medals', col='red')
```

На рис. 14 мы видим аналогичную с рис. 11 ситуацию, то есть среднее значение доли школьников получивших золотую медаль наибольшее в школе с физико-математическим уклоном. Подобные графики позволяют нам уже видеть, что интерквартильные размахи групп пересекаются. Тем не менее вопрос «Являются ли эти различия статистически значимыми?» остается по-прежнему открытым.

Аналогичный график строим для районов в которых находятся школы (рис. 15):

```{r, fig.cap='Рис. 15. Ящичковая диаграмма (box plot) доли школьников получивших золотую медаль в зависимости от типа школы (построена с помощью встроенной функции boxplot)'}
boxplot(Medals ~ District, data=data, ylab='Medals', col='blue')
```

На рис. 15 та же тенденция, что и на графике средних (рис. 12).

Построим скрипичную диаграмму для наших данных. Сначала установим пакет `ggplot2`:

```{r}
library('ggplot2')
```

Установим категориальный (факторный) тип переменной `School_type`:

```{r}
data$School_type <- as.factor(data$School_type)
```

И зададим скрипичный график:

```{r, fig.cap='Рис. 17. Скрипичная диаграмма (violin plot) доли школьников получивших золотую медаль в зависимости от типа школы'}
p <- ggplot(data, 
            aes(x = School_type, y = Medals, fill = School_type)) + geom_violin(trim = FALSE) 
p
```

Как видим, рис. 17 более информативен, чем рис. 14 -- мы имеем гораздо больше информации о распределении признака внутри каждой группы. Для удобства мы можем повернуть скрипичную диаграмму набок -- поменять оси местами (рис. 18):

```{r, fig.cap='Рис. 18. Перевернутая скрипичная диаграмма (violin plot) доли школьников получивших золотую медаль в зависимости от типа школы'}
p + coord_flip()
```

Также в R есть возможность наложить на скрипичную диаграмму ящичковую (рис. 19)

```{r, fig.cap='Рис. 19. Скрипичная и ящичковая диаграммы доли школьников получивших золотую медаль в зависимости от типа школы'}
p + geom_boxplot(width =0.2)
```

Удобной может оказаться также функция наложения скрипичной диаграммы и диаграммы рассеяния (рис. 20):

```{r, fig.cap='Рис. 20. Скрипичная диаграмма и диаграмма рассеяния доли школьников получивших золотую медаль в зависимости от типа школы'}
p + geom_dotplot(binaxis='y', stackdir='center', dotsize=1)
```

Установим категориальный (факторный) тип переменной `District`:

```{r}
data$District <- as.factor(data$District)
```

И зададим скрипичный график:

```{r, fig.cap='Рис. 21. Скрипичная диаграмма (violin plot) доли школьников получивших золотую медаль в зависимости от района в котором расположена школа'}
p <- ggplot(data, 
            aes(x=District, y=Medals, fill= District)) + geom_violin(trim=FALSE) 
p
```

Для удобства мы можем повернуть скрипичную диаграмму набок -- поменять оси местами (рис. 22):

```{r, fig.cap='Рис. 22. Перевернутая скрипичная диаграмма (violin plot) доли школьников получивших золотую медаль в зависимости от района в котором расположена школа'}
p + coord_flip()
```

Также в R есть возможность наложить на скрипичную диаграмму ящичковую (рис. 23)

```{r, fig.cap='Рис. 23. Скрипичная и ящичковая диаграммы доли школьников получивших золотую медаль в зависимости от района в котором расположена школа'}
p + geom_boxplot(width=0.2)
```

Удобной может оказаться также функция наложения скрипичной диаграммы и диаграммы рассеяния (рис. 24):

```{r, fig.cap='Рис. 24. Скрипичная диаграмма и диаграмма рассеяния доли школьников получивших золотую медаль в зависимости от района в котором расположена школа'}
p + geom_dotplot(binaxis='y', stackdir='center', dotsize=1)
```

##### 3.1.3. Проведение однофакторного дисперсионного анализа в R

Перейдем непосредственно к дисперсионному анализу. Основными предпосылками к применению дисперсионного анализа являются требования, чтобы:

-   наблюдения подчинялись нормальному закону,

-   дисперсии в группах были примерно равны.

Перед применением статистических тестов визуально мы также можем проверить, соответствует ли распределение доли школьников получивших золотую медаль нормальному, например, с помощью графика квантиль-квантиль (quantile-quantile plot). Построим такой график с помощью пакета `car`.

```{r, fig.cap='Рис. 25. График квантиль-квантиль доли школьников получивших золотую медаль и нормального распределения (построен с помощью функции qqPlot пакета car)'}
library('car') 
qqPlot(data$Medals)
```

На графике (рис. 25) можем зрительно оценить подгонку теоретического распределения к наблюдаемым значениям. Как видим, сопоставимость достаточно высока, точки наблюдаемых значений сосредоточены вдоль прямой равенства эмпирических и теоретических квантилей, поэтому можем предположить, что доля школьников получивших золотую медаль подчиняется нормальному распределению. Давайте теперь формально проверим, что наша выборка действительно подчиняется нормальному распределению. Переменной, используемой для проведения дисперсионного анализа, в данном случае является доля школьников получивших золотую медаль, именно для нее мы проверим гипотезу о нормальности.

Для этого существует множество тестов, мы же применим критерий Шапиро-Уилка, наиболее подходящий для малых выборок.

```{r}
shapiro.test(data$Medals)
```

Как видим, значение p-value = 0.6159 больше заданного в 5% уровня значимости, значит, нулевая гипотеза о соответствии зависимой переменной нормальному распределению в нашем случае не отвергается, следовательно, мы можем применять дисперсионный анализ.

Теперь проверим вторую предпосылку применения дисперсионного анализа -- однородность дисперсий между уровнями каждого фактора с помощью теста Левене -- используем функцию `leveneTest `из пакета `car`.

Проверим тип наших переменных, и получим, что обе переменных -- факторные, что и необходимо для корректного проведения дисперсионного анализа:

```{r}
str(data$School_type)

str(data$District)
```

Теперь можно провести тест Левене с медианами по умолчанию и средними дополнительно:

```{r}
leveneTest(data$Medals, data$School_type)

leveneTest(data$Medals, data$School_type, center=mean)
```

В обоих случаях p-value больше любого разумного уровня значимости, поэтому нулевая гипотеза об однородности дисперсий между группами фактора типа школы не отвергается.

И то же самое проводим с фактором района:

```{r}
leveneTest(data$Medals, data$District)

leveneTest(data$Medals, data$District, center=mean)
```

В обоих случаях p-value = 0.8949 (0.229) больше любого разумного уровня значимости, поэтому нулевая гипотеза об однородности дисперсий между группами фактора района в котором находится школа также не отвергается.

Итак, все предпосылки применения дисперсионного анализа проверены, можно приступать к самому анализу.

Дисперсионный анализ в пакете R реализуем функцией `aov()` --- analysis of variance, анализ дисперсии.

Для начала мы проверим гипотезу о том, что доли золотых медалей, полученных школьниками равны в среднем по типу школы.

Нулевая гипотеза, проверяемая в дисперсионном анализе -- что средние всех уровней фактора равны (фактор не влияет на зависимую переменную Y):

```{r}
summary(aov(data$Medals ~ data$School_type))
```

В данном случае мы должны посмотреть на значение p-value оно больше чем 0.5. Соответственно, на уровне значимости $\alpha = 0.05$ нулевая гипотеза не отвергается, т.е. мы не можем считать влияние данного фактора статистически значимым.

Проведём аналогичный анализ для второй переменной - района в котором находится школа. Это будет тоже однофакторный дисперсионный анализ без рассмотрения другого фактора.

```{r}
summary(aov(data$Medals ~ data$District))
```

Здесь также проверяется гипотеза о том, что средние равны, и как в предыдущем случае, значение p-value = 0.127 у нас получилось больше, чем 0.05. Соответственно, гипотеза о равенстве средних по уровням данного фактора у нас не отвергается на уровне значимости $\alpha = 0.05$. Следовательно, можно сделать вывод о том, что район в котором находится школа не влияет на долю школьников получивших золотые медали, или по данной выборке (очень небольшого объема) влияние фактора не доказано.

#### 3.2. Двухфакторный дисперсионный анализ (Two-Way ANOVA)

Проведём двухфакторный дисперсионный анализ, когда в рассмотрение будут включены оба фактора.

##### 3.2.1. Без учета взаимодействия факторов (n = 1)

Поскольку в исходной таблице было по одному наблюдению в каждой ячейке, мы не можем рассматривать эффект взаимодействия факторов. То есть просто добавляем теперь влияние двух факторов в нашу модель:

```{r}
summary((aov(data$Medals ~ data$School_type + data$District)))
```

Здесь дисперсии немного перераспределились, как раз-таки по двум предположительно влияющим факторам. У нас часть дисперсии объясняется фактором типа школы, часть дисперсии объясняется влиянием района в котором расположена школа, и также, естественно, присутствует остаточная дисперсия.

В последнем столбце мы видим значение p-value для проверки гипотез о равенстве средних по всем уровням соответствующего фактора. Что для типа школы, что для района p-value больше чем 0.05, соответственно мы не отвергаем нулевую гипотезу о равенстве средних, как для фактора типа школы, так и для фактора района, в котором располагается школа.

##### 3.2.2. Проверка равенства средних выбранных уровней (post hoc tests) -- тест Тьюки

Проведем тест Тьюки TukeyHSD (от англ. "honestly significant difference") для сравнения доли школьников получивших золотую медаль по типу школы:

```{r}
anova_data <- aov(data$Medals ~ data$School_type) 
summary(anova_data)
TukeyHSD(anova_data)
```

Результат проведения теста Тьюки приведён в нижней части кода.

Как можно видеть, для всех групп доверительный интервал содержит ноль, а p-value превышает 0.05, вследствие чего нулевая гипотеза о равенстве средних  не отвергается на уровне значимости $\alpha=0.05$, поскольку у всех сравниваемых групп p-value \> 0.05, и соответствующий доверительный интервал включает в себя ноль.

Этот вывод подтверждается результатами проверки основной гипотезы дисперсионного анализа, представленными в верхней части кода (которые уже рассматривались в разделе 3.2.1): p-value \> $\alpha = 0.05$, вследствие чего нулевая гипотеза о равенстве средних выбранных уровней не отвергается на уровне значимости $\alpha = 0.05$ так как между всеми уровнями нет значимых различий.

Теперь можем визуализировать полученные результаты теста, построив 95-процентные доверительные интервалы для всех уровней фактора типа школы (рис. 26):

```{r, fig.cap='Рис. 26. Доверительные интервалы с надежностью 0,95 для разницы средних по типу школы'}
tukey <- TukeyHSD(anova_data) 
plot(tukey)
```

Эта визуализация подтверждает полученные выше результаты -- как можно видеть, для всех групп доверительный интервал содержит 0, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости.

Теперь проведем тест Тьюки TukeyHSD (от англ. "honestly significant difference") для сравнения средней доли школьников получивших золотую медаль по району в котором расположена школа:

```{r}
anova_data <- aov(data$Medals ~ data$District) 
summary(anova_data)
TukeyHSD(anova_data)
```

Как можно видеть, для всех групп доверительный интервал содержит ноль, а p-value превышают 0.05, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости.

Этот вывод подтверждается результатами проверки основной гипотезы дисперсионного анализа, представленными в верхней части кода (которые уже рассматривались в разделе 3.2.1).

Теперь можем визуализировать полученные результаты теста, построив 95-процентные доверительные интервалы для всех районов в которых находятся школы (рис. 27):

```{r, fig.cap='Рис. 27. Доверительные интервалы с надежностью 0,95 для разницы средних выборных в зависимости от района где располагается школа'}
tukey <- TukeyHSD(anova_data) 
plot(tukey)
```

Эта визуализация подтверждает полученные выше результаты -- как можно видеть, для всех групп доверительный интервал содержит $0$, вследствие чего *нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости* (левая граница доверительного интервала -- отрицательна, правая положительна -- т.е. непонятно даже, у какого из уровней фактора больше, а у какого меньше доля школьников получивших золотую медаль согласно доверительному интервалу).
